---
title: "gps_finalProject"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data reproducibility class, GPS final project

### Project overview
Within-species variation is ubiquitous in nature, and can often have large impacts on the fitness of individuals and the outcomes of species interactions. Despite this, species interactions are frequently investigated at the level of species, with biologically important variation being treated as noise. This is particularly true for studies at larger community scales due to the logistical difficulties of gathering individual-level data.

Although there are many drivers of intraspecific variation, sex generates large, discrete, and predictable differences between individuals in their morphology and behavior. As such, sex may represent a perfect middle ground between the species-level and the individual-level that captures ecologically-relevant variation withough the logistical and computation challenges of individual-level analyses. Despite large sex-associated differences in morphology, foraging behavior and more being common knowledge, how these differences influence species interactions is unknown for many types of species interactions.

For my project, I will build plant-pollinator networks at species-level and at the sex-level to investigate how the behavioral differences between male and female floral visitors influence species interactions within larger plant and pollinator communities.  


### Data sources
To build these networks, I will use plant-pollinator interaction matrices from Yosemite Valley, the California Central Valley, and the Sky Islands. These datasets represent a wide variety of habitats and land use types, and cover a wide diversity of plant and pollinator taxa (primarily bees and syrphids). All of the datasets are availalbe in online repositories that Lauren will get me access to.

Yosemite: Ponisio et al. 2016 Global Change Biology
  -2 yrs of sampling, 18 sites, 3 rep per year

Central Valley: Kremen et al., ongoing
  -10 yrs, 10-39 sites, 2-5 times each

Sky islands: Ponisio et al., ongoing
  -3 yrs, 5-8 sites, 2-3 times each


### Key questions
1. Do sex differences in behavior cause males and females  to have different network roles?

2. Do specialist taxa show smaller differences between sexes than more generalist taxa?

3. Do bees show larger differences between sexes than flies do?

4. Does describing these networks at the level of sex reduce their predicted robustness in the face of species loss?


### Question 1: Do sex differences in behavior cause males and females  to have different network roles?

Because males (by and large) shoudl be expected to prioritize finding mates, they have been observed to fly further and be more opportunistic in their floral visitation than females. As such, I hypothesize that males will be more generalized than female trying to efficiently gather resources for their offspring. 

To test this, I will examine a number of node-level network traits, especially degree (number of links), species strength (how dependant plants are on that node), and centrality (betweenness and closeness: is the node nested in the middle or peripheral in the network). 

I predict that males will have a higher degree, lower speices strength, and higher centrality than the females. 

#### Step 1: Import, clean, and combine data

First, innitiate by loading libraries

```{r, echo=TRUE, results="hide"}
rm(list=ls())
options(warn=-1)
library(piggyback, quietly=TRUE, warn.conflicts = FALSE)
library(igraph, quietly=TRUE, warn.conflicts = FALSE)
library(vegan, quietly=TRUE, warn.conflicts = FALSE)
library(fields, quietly=TRUE, warn.conflicts = FALSE)
library(fossil, quietly=TRUE)
library(bipartite, quietly=TRUE)
library(tidyverse, quietly=TRUE)
library(stringr, quietly=TRUE)
library(nlme, quietly=TRUE)
library(sciplot, quietly=TRUE)
library(parallel, quietly=TRUE)
library(SYNCSA, quietly=TRUE)
```

Next, load functions  from other files, which reduces clutter in the code here

```{r}

source('misc.R')
source('prepNets.R')

```

If not already present, download raw data from the appropriate datasets from the release associated with my Git repo via the piggyback package. Requires a git token for access.

```{r}
#Sys.getenv("GITHUB_PAT")
pb_download("specimens-yos.csv",
            dest="data",
            tag="data.v.1")
pb_download("specimens-hr.RData",
            dest="data",
            tag="data.v.1")
```


Now we'll load in and clean up the Yosemite dataset

```{r}
##YOSEMITE DATA

spec.y <-read.csv("data/specimens-yos.csv")

## drop pan data
spec.y <- spec.y[spec.y$NetPan == "net",]

## drop extra round at L21 when field crew did not sample correctly from specimens
extra.round <- spec.y$Site == 'L21' & spec.y$Date == '2014-07-01'
spec.y <- spec.y[!extra.round,]

## get specimen data ready.
spec.y<-dat.clean(spec.y) #combines the Genus and species columns into a single GenusSpecies column for both plants and pollinators

spec.y<-dat.dates(spec.y) #adds date columns in the appropriate formats


## drop non-bee, non-Syrphids
spec.y <- spec.y[spec.y$Family %in% c("Andrenidae", 
                                      "Apidae",
                                      "Colletidae",
                                      "Halictidae",
                                      "Megachilidae",
                                      "Syrphidae"),]

## for networks, drop specimens without plant IDs (or bee IDs)
spec.y<-dat.rm.blanks(spec.y)
spec.y$GenusSpeciesSex<-ifelse(spec.y$Sex %in% c("m","f"),
                               paste(spec.y$GenusSpecies,
                                     spec.y$Sex,sep="_"),
                               paste(spec.y$GenusSpecies,
                                     "e",sep="_")
)

spec.y[1:3,]

```


Next we do the same thing for the Hedgerow dataset

```{r}
##HEDGEROW DATA

load("data/specimens-hr.RData",verbose=TRUE) 
  #For whatever reason, resulting df is called "dd"
spec.h<-dd


## get specimen data ready.
spec.h<-dat.clean(spec.h)
spec.h$Date<-as.Date.character(spec.h$Date)
spec.h<-dat.dates(spec.h)

## drop non-bee, non-Syrphids
spec.h <- spec.h[spec.h$Family %in% c("Andrenidae", 
                                      "Apidae",
                                      "Colletidae",
                                      "Halictidae",
                                      "Megachilidae",
                                      "Syrphidae"),]

## for networks, drop specimens without plant IDs (or bee IDs)
spec.h<-dat.rm.blanks(spec.h)

spec.h$GenusSpeciesSex<-ifelse(spec.h$Sex %in% c("m","f"),
                               paste(spec.h$GenusSpecies,
                                     spec.h$Sex,sep="_"),
                               paste(spec.h$GenusSpecies,
                                     "e",sep="_")
)

spec.h[1:3,]

```


Finally, bind the dataframes together, keeping only a few columns of interest.

```{r}

#list of columns to keep
keeps<-c("UniqueID",
         "GenusSpecies",
         "Site",
         "Year",
         "PlantGenusSpecies",
         "GenusSpecies",
         "GenusSpeciesSex",
         "Sex")

#bind together the rows from both datasets for those columns
bind_rows(select(spec.y,keeps),
          select(spec.h,keeps))->
  spec.all

#Add a Site + Year column to speed some things along
spec.all$SiteYr<-paste(spec.all$Site,spec.all$Year)

spec.all[1:3,]

```



#### Step 2: Randomize sexes and calculate network roles

Because the number of males and females caught is likely to differ substantially, and abundance in the networks is related to many network parameters, we'll examine the difference between males and females using a null model approach.

Many of these steps are very long and computer-time intensive. As such, many of them are run using the mclapply function from the parallel package, which allows different computer cores to each tackle a different iteration of a task. 


First, we generate 999 simulated networks, where for each species within each network the "male" and "female" lables on each individual pollinator are shuffled randomly. We do this with the ran.gen function. This function also removes any networks where there isn't at least 1 species present with both males and females

IMPORTANT NOTE: DON'T actually run this step (or many of the subsequent steps) unless you have a bunch of time. We'll load in the appropriate objects below when necessary. I've commented out all of these long steps.

```{r}
#specify the number of cores to use for these tasks. I used 10 on Lauren's computer ("osmia"), 3 for the lab computer ("bombus")
cores <- 10

#rand.sexes.ls<-ran.gen(spec.all,999,cores)

#save("data/rand.sexes.RData")

```


ran.gen outputs a giant list object with 1000 elements in it; each element is the full spec.all dataframe, though the GenusSpeciesMix column has a random shuffle of sexes within each species. To quickly check that they did actually mix: 

```{r}

#pb_download("rand.sexes.RData",dest="data",tag="data.v.1")

#To avoid running ran.gen again, load the object
load("data/rand.sexes.RData")

## checking that they mixed
rand.sexes.ls[[1]] %>% #element 1 is our actual observed network
	filter(SiteYr == 'Zamora 2014', 
	       GenusSpecies == "Halictus tripartitus",
	       Sex == "m") %>%
	select(GenusSpeciesMix,UniqueID)

rand.sexes.ls[[2]] %>% #element 2 is a simulated network
	filter(SiteYr == 'Zamora 2014',
	       GenusSpecies == "Halictus tripartitus",
	       Sex == "m") %>%
	select(GenusSpeciesMix,UniqueID)

```


Next, we build a network for each site for each year by appling the breakNetMix function to each element in the rand.sexes.ls list. breakNetMix essentially chops up the dataframe into each individual network, then puts it in a visitation occurance matrix. 

```{r}

#nets.mix<-mclapply(rand.sexes.ls, 
#                   function(y){
#                     breakNetMix(y, 
#                                 'Site', 
#                                 'Year', 
#                                 'GenusSpeciesMix')},
#                   mc.cores = cores)


##remove all networks with too few interactions to calculate metrics
#nets.mix.clean<-mclapply(nets.mix, 
#                         function(x){
#                           x[sapply(x,function(y) all(dim(y)>1))]},
#                         mc.cores=cores)

##save the networks themselves
#save(nets.mix.clean, file = 'data/mix_netsYH.RData')

```


Again, we'll just load in the data to confirm that the networks are different, and to see the format of the output

```{r}
load("data/mix_netsYH.RData")

## confirm that the networks are actually different
nets.mix.clean[[1]]$Zamora.2014 #our observed network
nets.mix.clean[[2]]$Zamora.2014 #our 1st simulated network
```


Lastly, we use the specieslevel function from the bipartite package to calculate a ton of node-level network statistics for each node within each network (i.e., each sex). To do so we apply the calcSpec function to each network for each simulated dataset. calcSpec is a custom function that essentially runs specieslevel for each network, then transforms the output into a clean dataframe. 

```{r}
#sex.trts.mix<-mclapply(nets.mix.clean,
#                       function(x) calcSpec(x), 
#                       mc.cores = cores)

#save(sex.trts.mix,file='data/sex_trts_mixYH.RData')

load("data/sex_trts_mixYH.RData")

## confirm that the values are different
sex.trts.mix[[1]] %>%
	filter(Site == "Zamora", Year == 2014)

sex.trts.mix[[2]] %>%
	filter(Site == "Zamora", Year == 2014)

```


#### Step 3: Calculate how different males and females were in the observed networks compared to the simulated networks

First, a bit of cleanup.

```{r}
##clean up the datasets, add some necessary columns to speed things up
#traits.ls <- 
#  mclapply(sex.trts.mix, function(x){
#  x$SiteYr <- paste(x$Site, x$Year, sep="_")
#  x$Sp <- gsub( "_.*$", "", x$GenusSpecies )
#  x <- filter(x,x$sex == "m" | x$sex == "f")
#  droplevels(x$sex) #doesn't seem to work for whatever reason...
#  return(x)
#},mc.cores=cores)

```


Next calculate how different males and females are within each species for each network within each simulation using the makeComp function. 

Essentially, it narrows down to each species within each network within each simulation, calculates a difference value between males and females, then binds all those differences together. It also drops all species within a given network that don't have both males and females present. 

Here I specify the comparison to be (male value) - (female value). Alternatively it could be log (female / male), but this doesn't work well for metrics that can have a value of 0. 

```{r}
##list of metrics we'll be examining
metric.ls <- c("degree",
               "species.strength",
               "weighted.betweenness",
               "weighted.closeness" )

##apply makeComp to the traits.ls 
#sexDiffs.df <- makeComp(traits.ls, #data (list of dfs)
#                        metric.ls, #metrics of interest (list)
#                        comparison = "diff") #comparison to make


#save(sexDiffs.df, file = 'data/sexDiffs.RData')

load('data/sexDiffs.RData') #object: sexDiffs.df

head(sexDiffs.df[[1]])

```


In this output, a more positive value indicates that males have a higher score than females. 


Next, we calculate the magnitude of the male-female difference in the observed networks relative to the simulated networks using the calcNullProp50 function. This function puts all of the simulations into 1 very long dataset, then compares the observed differences (from element 1) to the rest. 

It can do this either by calculating z-scores, or by calcualting the proportion of simulated difference values less than or equal to the observed difference value. To be more conservative, the proportion equal to the observed difference value is divided by 2. 


```{r}

##by proportion > or 50% = to observed
#sexDiffsProp50.df <- calcNullProp50(sexDiffs.df, #data
#                                    metric.ls, #metrics
#                                    zscore=F) #use proportions

#save(sexDiffsProp50.df,file='data/sexDiffsProp50YH.df')

load("data/sexDiffsProp50YH.df") #object: sexDiffsProp50.df

head(sexDiffsProp50.df)

```


The output here indicates the proportion of simulations for a given observation (i.e., species + network combo) that differed from our observed values. 

High proportions indicate that observed males had larger values than simulated males in the majority of simulations. 


#### Step 4: Testing

As a test / summary across all of the species and networks, we run a function called overallTest. This function calculates the proportion of observations (Sp + network) where the proportions calculated above fall outside thresholds. It can either do a 1 tailed test (5% threshold in 1 direction) or 2 tailed (2.5% in each direction). 

```{r}

overallTest(sexDiffsProp50.df,metric.ls,zscore=F)

```


High values indicate that observed males had larger values than males in the majority of simulations for the majority of observations. So these results suggest that males actually have LOWER values for all of these metrics.  

To break these results down by species, we use spLevelTest, which essentially applies overallTest to each species individually. 

```{r}

spLevelTest(sexDiffsProp50.df,metric.ls,zscore=FALSE)

```


Hmmm something seems wrong here. Too many zeros...


#### Step 5: Data visualization

To visualize this pattern and see what's going on, we first have to generate null distributions using genNullDist. This takes the mean difference value for each observation (species within network) across all simulations, then subtracts the observed difference from it. 

```{r}
##averages by sp+site+year (how overallTest was run)
#nullDistDiff.df <- genNullDist(sexDiffs.df, #data
#                               metric.ls, #metrics
#                               zscore=F) #

#save(nullDistDiff.df,file='data/nullDistDiff.RData')

load("data/nullDistDiff.RData")

head(nullDistDiff.df)

```


To visualize this data, we just use a density plot. If males have higher values than expected (i.e., higher than simulated), the distribution should be skewed to the left of 0 

```{r}

##density plot for degree, absolute differences
plot(density(nullDistDiff.df$degree,na.rm = T))
abline(v=0)

```


There are a few striking things about this plot. There doesn't seem to be a clear skew, but that is entirely overwhelemed by the HUGE spike at 0. For the the vast majority of observations, the values in the observed networks did not differ from the simulated networks at all. Turns out that over a third of the observations are zeros.

Looking at the data, its likely that this is due to a combination of there being too few males to shuffle adequately and species visiting relatively few plants regardless of sex. 

```{r}
load("data/mix_netsYH.RData")

plotweb(nets.mix.clean[[1]]$Zamora.2014)

```



### Conclusion

I don't think I can conclude much yet. The nulls aren't really appropriate as currently simulated since there isn't enough meaningful shuffling.


### Future steps:

-Add Sky Islands data

-Limit analyses to species with at least two of each sex

##### Many more questions of interest

  -Does the amount of difference depend on species-level specialization?
  
  -Are certain taxonomic groups differing more or less?
  
  -How does the inclusion / treatment of males impact NETWORK-level statistics like nestedness and robustness?
  
  -etc